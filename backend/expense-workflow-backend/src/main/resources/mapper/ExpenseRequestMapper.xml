<?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.example.expenseworkflow.mapper.ExpenseRequestMapper">
	<resultMap id="ExpenseRequestResultMap"
		type="com.example.expenseworkflow.domain.ExpenseRequest">
		<id column="id" property="id" />
		<result column="applicant_id" property="applicantId" />
		<result column="current_approver_id"
			property="currentApproverId" />
		<result column="title" property="title" />
		<result column="expense_date" property="expenseDate" />
		<result column="apply_date" property="applyDate" />
		<result column="amount" property="amount" />
		<result column="purpose" property="purpose" />
		<result column="payment_method" property="paymentMethod" />
		<result column="status" property="status" />
		<result column="submitted_at" property="submittedAt" />
		<result column="approved_at" property="approvedAt" />
		<result column="last_returned_at" property="lastReturnedAt" />
		<result column="last_return_comment"
			property="lastReturnComment" />
		<result column="created_at" property="createdAt" />
		<result column="updated_at" property="updatedAt" />
		<result column="note" property="note" />
	</resultMap>

	<select id="selectRequestSummaries"
		resultType="com.example.expenseworkflow.controller.dto.RequestSummaryResponse">
		SELECT er.id AS id, er.title AS title,
		er.amount AS amount, er.status AS status, COALESCE(er.note,
		'') AS note,
		er.last_return_comment AS lastReturnComment
		FROM expense_requests er ORDER BY er.id DESC
	</select>

	<select id="selectRequestSummariesByApplicant"
		resultType="com.example.expenseworkflow.controller.dto.RequestSummaryResponse">
		SELECT er.id AS id, er.title AS title,
		er.amount AS amount, er.status AS status, COALESCE(er.note,
		'') AS note,
		er.last_return_comment AS lastReturnComment
		FROM expense_requests er WHERE er.applicant_id = #{applicantUserId} ORDER BY er.id DESC
	</select>

	<select id="selectExpenseRequestById"
		resultMap="ExpenseRequestResultMap">
		SELECT er.* FROM expense_requests er WHERE er.id = #{id}
	</select>

	<select id="selectExpenseRequestByIdAndApplicant"
		resultMap="ExpenseRequestResultMap">
		SELECT er.* FROM expense_requests er WHERE er.id = #{id} AND er.applicant_id = #{applicantUserId}
	</select>

	<insert id="insertExpenseRequest"
		parameterType="com.example.expenseworkflow.domain.ExpenseRequest"
		useGeneratedKeys="true" keyProperty="id">
		INSERT INTO expense_requests (
		applicant_id, current_approver_id, title,
		amount, status, note ) VALUES
		( #{applicantId}, #{currentApproverId},
		#{title}, #{amount}, #{status},
		#{note} )
	</insert>
	
	<insert id="insertExpenseRequestAction"> <!-- 操作履歴を expense_request_actions に1行INSERTするSQLを定義する -->
		INSERT INTO expense_request_actions ( <!-- 履歴テーブルへ挿入する対象カラム一覧を指定する -->
			request_id, <!-- 対象申請ID（expense_requests.id）を保存する -->
			actor_id, <!-- 操作したユーザーIDを保存する -->
			action, <!-- 操作種別（RETURN等）を保存する -->
			from_status, <!-- 遷移前ステータスを保存する -->
			to_status, <!-- 遷移後ステータスを保存する -->
			comment <!-- 差戻しコメントを保存する -->
		) VALUES ( <!-- INSERTの値リストを開始する -->
			#{requestId}, <!-- request_id に対象申請IDをバインドして保存する -->
			#{actorId}, <!-- actor_id に操作ユーザーIDをバインドして保存する -->
			#{action}, <!-- action に操作種別をバインドして保存する -->
			#{fromStatus}, <!-- from_status に遷移前ステータスをバインドして保存する -->
			#{toStatus}, <!-- to_status に遷移後ステータスをバインドして保存する -->
			#{comment} <!-- comment に差戻しコメントをバインドして保存する -->
		) <!-- VALUES句を閉じる -->
	</insert> <!-- insert定義を閉じる -->

	<select id="selectInboxItems"
		resultType="com.example.expenseworkflow.controller.dto.InboxItemResponse">
		SELECT er.id AS id, er.title AS title,
		er.amount AS amount, er.status AS status FROM
		expense_requests er
		WHERE er.current_approver_id = #{approverUserId}
		AND er.status =
		'SUBMITTED' ORDER BY er.id ASC
	</select>

	<select id="selectExpenseRequestByIdAndApprover"
		resultMap="ExpenseRequestResultMap">
		SELECT er.* FROM expense_requests er
		WHERE er.id = #{id} AND er.current_approver_id = #{approverUserId}
	</select>

	<update id="updateStatusForApplicant"> <!-- 申請者のsubmitで、DRAFT/RETURNED→SUBMITTEDへ遷移させつつ承認者を割り当てる更新SQLを定義します。 -->
		UPDATE expense_requests <!-- 更新対象は申請テーブル（expense_requests）です。 -->
		SET status = #{toStatus}, <!-- status をSUBMITTEDに更新して、Inbox検索条件（status='SUBMITTED'）を満たします。 -->
		current_approver_id = #{approverUserId}, <!-- 承認者IDをセットして、Inbox検索条件（current_approver_id一致）を満たします。 -->
		submitted_at = CURRENT_TIMESTAMP <!-- 提出時刻を記録して、提出済みの事実をDB上に残せるようにします。 -->
		WHERE id = #{id} <!-- 対象申請IDを一致させて、別の申請を更新しないようにします。 -->
		AND applicant_id = #{applicantUserId} <!-- 申請者本人の申請だけ更新できるようにして、他人の申請のsubmitを防ぎます。 -->
		AND status IN ('DRAFT','RETURNED') <!-- DRAFTに加えてRETURNEDからもSUBMITTEDへ再提出できるようにして、差戻し後の再提出を成立させます。 -->
	</update>

	<update id="updateEditableFieldsForApplicant"> <!-- 申請者が差戻し（RETURNED）申請を編集保存するための更新SQLを定義します。 -->
		UPDATE expense_requests <!-- 更新対象は申請テーブル（expense_requests）です。 -->
		SET title = #{title}, <!-- タイトルを更新して、差戻し指摘を反映できるようにします。 -->
		amount = #{amount}, <!-- 金額を更新して、差戻し指摘を反映できるようにします。 -->
		note = #{note}, <!-- 備考を更新して、差戻し指摘を反映できるようにします。 -->
		updated_at = CURRENT_TIMESTAMP <!-- 更新時刻を更新して、編集した事実をDB上に残せるようにします。 -->
		WHERE id = #{id} <!-- 対象申請IDを一致させて、別の申請を更新しないようにします。 -->
		AND applicant_id = #{applicantUserId} <!-- 申請者本人の申請だけ更新できるようにして、他人の申請の編集保存を防ぎます。 -->
		AND status IN ('DRAFT','RETURNED') <!-- DRAFT（下書き）とRETURNED（差戻し）のときだけ編集保存できるようにして、提出済み等の編集を防ぎます。 -->
	</update>
	
	<update id="updateStatusForApprover">
		UPDATE expense_requests SET status = #{toStatus}
		WHERE id = #{id} AND
		current_approver_id = #{approverUserId}
	</update>

	<update id="updateStatusForApproverWithComment"> <!-- 差戻し専用：status/last_return_comment/last_returned_atを同時更新するSQLを定義する -->
		UPDATE expense_requests
		SET status = #{toStatus}, <!-- statusをRETURNEDに更新して差戻し状態を反映する -->
		last_return_comment = #{comment}, <!-- 差戻しコメントをexpense_requestsに直接書き込み、申請者が一覧・詳細で参照できるようにする -->
		last_returned_at = CURRENT_TIMESTAMP <!-- 差戻し日時を記録して、いつ差し戻されたかをDB上に残す -->
		WHERE id = #{id} <!-- 対象申請IDを一致させて、別の申請を更新しないようにする -->
		AND current_approver_id = #{approverUserId} <!-- 承認者本人の申請だけ更新できるようにして、他人のInbox申請の操作を防ぐ -->
	</update>
	
	<update id="updateStatusToWithdrawn"> <!-- 申請者が申請を取り下げる（DRAFT/RETURNED → WITHDRAWN）ためのSQLを定義する -->
		UPDATE expense_requests
		SET status = 'WITHDRAWN',
		    updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id}
		AND applicant_id = #{applicantUserId}
		AND status IN ('DRAFT','RETURNED') <!-- DRAFT（下書き）とRETURNED（差戻し）のときだけ取り下げ可能にする -->
	</update>

	<update id="updateStatusToRejected"> <!-- 承認者が申請を却下する（SUBMITTED → REJECTED）ためのSQLを定義する -->
		UPDATE expense_requests
		SET status = 'REJECTED',
		    updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id}
		AND current_approver_id = #{approverUserId}
		AND status = 'SUBMITTED' <!-- SUBMITTED のときだけ却下可能にする -->
	</update>

</mapper>